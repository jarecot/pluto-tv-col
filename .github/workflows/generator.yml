name: Pluto TV - Sync Total
on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Descargar Fuentes Frescas
        run: |
          curl -L -s "https://raw.githubusercontent.com/iptv-org/iptv/master/streams/mx_pluto.m3u" -o playlist.m3u
          curl -L -s "https://raw.githubusercontent.com/matthuisman/i.mjh.nz/refs/heads/master/PlutoTV/mx.xml" -o epg_raw.xml

      - name: Procesar con Python (Extracción Mejorada)
        run: |
          python3 - <<EOF
          import xml.etree.ElementTree as ET
          import re
          import os

          m3u_ids = set()
          try:
              # 1. Extracción ultra-robusta de IDs
              if os.path.exists('playlist.m3u'):
                  with open('playlist.m3u', 'r', encoding='utf-8') as f:
                      content = f.read()
                      # Buscamos tvg-id="valor" o tvg-id='valor' o incluso channel-id=
                      found = re.findall(r'tvg-id=["\']([^"\']+)["\']', content)
                      for fid in found:
                          m3u_ids.add(fid)
                          
              print(f"IDs encontrados en M3U: {len(m3u_ids)}")

              # 2. Cargar el EPG
              tree = ET.parse('epg_raw.xml')
              root = tree.getroot()

              # 3. Validar cuántos canales del XML coinciden
              matches = 0
              for channel in root.findall('channel'):
                  if channel.get('id') in m3u_ids:
                      matches += 1
              
              print(f"Coincidencias reales con el EPG: {matches}")

              # 4. Guardar archivo final
              tree.write('epg.xml', encoding='utf-8', xml_declaration=True)
              print("Archivo epg.xml generado correctamente.")

          except Exception as e:
              print(f"Error: {e}")
              exit(1)
          EOF

      - name: Publicar Cambios
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Bot"
          rm -f epg_raw.xml
          git add playlist.m3u epg.xml
          git commit -m "Sync Total: $(date +'%Y-%m-%d %H:%M:%S')" || exit 0
          git push origin main --force
