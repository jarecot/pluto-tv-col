name: Pluto TV - Auto Sync Matt Huisman
on:
  schedule:
    - cron: '0 */6 * * *' # Se ejecuta cada 6 horas
  workflow_dispatch: # Permite ejecutarlo manualmente

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Descargar M3U e XMLTV
        run: |
          # Descargar la lista estable de iptv-org
          curl -L -s "https://raw.githubusercontent.com/iptv-org/iptv/master/streams/mx_pluto.m3u" -o playlist.m3u
          
          # Descargar el EPG actualizado de Matt Huisman
          curl -L -s "https://raw.githubusercontent.com/matthuisman/i.mjh.nz/refs/heads/master/PlutoTV/mx.xml" -o epg_raw.xml

      - name: Sincronización Inteligente (Python)
        run: |
          python3 - <<EOF
          import xml.etree.ElementTree as ET
          import re

          try:
              # 1. Mapear los IDs presentes en la lista M3U
              m3u_ids = set()
              with open('playlist.m3u', 'r', encoding='utf-8') as f:
                  for line in f:
                      if 'tvg-id="' in line:
                          match = re.search(r'tvg-id="([^"]+)"', line)
                          if match:
                              m3u_ids.add(match.group(1))

              # 2. Cargar el XML de Matt Huisman
              tree = ET.parse('epg_raw.xml')
              root = tree.getroot()

              # 3. Validar coincidencias
              count = 0
              for channel in root.findall('channel'):
                  if channel.get('id') in m3u_ids:
                      count += 1
              
              print(f"Sincronización exitosa: {count} canales con guía encontrados.")
              
              # 4. Guardar como epg.xml (el que leerá TiviMate)
              tree.write('epg.xml', encoding='utf-8', xml_declaration=True)
              
          except Exception as e:
              print(f"Error procesando EPG: {e}")
              exit(1)
          EOF

      - name: Publicar cambios en GitHub
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Bot"
          # Eliminamos el archivo temporal para no ensuciar el repo
          rm -f epg_raw.xml
          git add playlist.m3u epg.xml
          git commit -m "Auto-update Pluto EPG: $(date)" || true
          git push origin main --force
