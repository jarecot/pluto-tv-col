name: Pluto TV - Force Sync Matt Huisman
on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Descargar M3U e XMLTV
        run: |
          # Descargamos los archivos frescos
          curl -L -s "https://raw.githubusercontent.com/iptv-org/iptv/master/streams/mx_pluto.m3u" -o playlist.m3u
          curl -L -s "https://raw.githubusercontent.com/matthuisman/i.mjh.nz/refs/heads/master/PlutoTV/mx.xml" -o epg_raw.xml

      - name: Sincronización de IDs (Python)
        run: |
          python3 - <<EOF
          import xml.etree.ElementTree as ET
          import re
          import os

          try:
              # 1. Mapear IDs de la lista
              m3u_ids = set()
              if os.path.exists('playlist.m3u'):
                  with open('playlist.m3u', 'r', encoding='utf-8') as f:
                      for line in f:
                          match = re.search(r'tvg-id="([^"]+)"', line)
                          if match:
                              m3u_ids.add(match.group(1))
              
              print(f"IDs encontrados en M3U: {len(m3u_ids)}")

              # 2. Procesar el XML
              tree = ET.parse('epg_raw.xml')
              root = tree.getroot()

              matches = 0
              for channel in root.findall('channel'):
                  if channel.get('id') in m3u_ids:
                      matches += 1
              
              print(f"Matches encontrados en XML: {matches}")

              # 3. Guardar el archivo FINAL
              # Forzamos la codificación UTF-8
              tree.write('epg.xml', encoding='utf-8', xml_declaration=True)
              print("Archivo epg.xml generado correctamente.")

          except Exception as e:
              print(f"Error CRÍTICO: {e}")
              exit(1)
          EOF

      - name: Publicar cambios
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Bot"
          
          # Borramos el temporal para que no se suba
          rm -f epg_raw.xml
          
          # Añadimos los archivos
          git add playlist.m3u epg.xml
          
          # El commit incluirá la fecha y hora para forzar el cambio en el historial
          git commit -m "Actualización forzada EPG: $(date +'%Y-%m-%d %H:%M:%S')" || echo "No hay cambios para subir"
          
          # Push con force para asegurar que GitHub actualice el endpoint
          git push origin main --force
