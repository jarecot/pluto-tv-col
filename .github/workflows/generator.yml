name: Pluto TV Latam Ultimate Sync
on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Descargar M3U y EPG
        run: |
          # 1. Descargamos la lista estable de iptv-org
          curl -L -s "https://raw.githubusercontent.com/iptv-org/iptv/master/streams/mx_pluto.m3u" -o playlist.m3u
          
          # 2. Descargamos el EPG de MJH (México)
          curl -L -s "https://i.mjh.nz/PlutoTV/mx.xml" -o epg_raw.xml

      - name: Sincronizar IDs (Python)
        run: |
          python3 - <<EOF
          import xml.etree.ElementTree as ET
          import re

          # 1. Parsear el EPG
          tree = ET.parse('epg_raw.xml')
          root = tree.getroot()

          # 2. Diccionario de mapeo basado en lo que usa la lista de iptv-org
          # El formato de iptv-org suele ser: hash.mx o slug.mx
          # Vamos a limpiar los IDs del EPG para que TiviMate los empareje fácil
          for channel in root.findall('channel'):
              disp_name = channel.find('display-name').text
              # El ID en MJH suele ser el nombre del canal. 
              # Lo dejamos limpio para que coincida con el logo y el nombre del M3U
              new_id = channel.get('id') 
              # No tocamos mucho aquí, MJH ya usa el 'id' que tu script local llama 'format=id'
          
          tree.write('epg.xml', encoding='utf-8', xml_declaration=True)
          EOF

      - name: Publicar en GitHub
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add playlist.m3u epg.xml
          git commit -m "Update Pluto: $(date)" || exit 0
          git push origin main
