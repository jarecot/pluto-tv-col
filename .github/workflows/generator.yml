name: Pluto TV Smart Sync - Force Update
on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Descargar Archivos
        run: |
          curl -L -s "https://raw.githubusercontent.com/iptv-org/iptv/master/streams/mx_pluto.m3u" -o playlist.m3u
          curl -L -s "https://i.mjh.nz/PlutoTV/mx.xml" -o epg_raw.xml

      - name: Mapeo de IDs por Nombre (Python)
        run: |
          python3 - <<EOF
          import xml.etree.ElementTree as ET
          import re

          try:
              m3u_channels = {}
              # Expresión regular mejorada para capturar tvg-id y el nombre final
              with open('playlist.m3u', 'r', encoding='utf-8') as f:
                  for line in f:
                      if line.startswith('#EXTINF'):
                          tid_match = re.search(r'tvg-id="([^"]+)"', line)
                          name_match = line.split(',')[-1].strip().lower()
                          if tid_match and name_match:
                              m3u_channels[name_match] = tid_match.group(1)

              tree = ET.parse('epg_raw.xml')
              root = tree.getroot()

              count = 0
              for channel in root.findall('channel'):
                  for dn in channel.findall('display-name'):
                      name = dn.text.strip().lower()
                      if name in m3u_channels:
                          old_id = channel.get('id')
                          new_id = m3u_channels[name]
                          channel.set('id', new_id)
                          # Actualizar programas
                          for prog in root.findall(f".//programme[@channel='{old_id}']"):
                              prog.set('channel', new_id)
                          count += 1
              
              print(f"Sincronizados {count} canales exitosamente.")
              tree.write('epg.xml', encoding='utf-8', xml_declaration=True)
          except Exception as e:
              print(f"Error procesando el EPG: {e}")
              exit(1)
          EOF

      - name: Publicar en GitHub
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Bot"
          # Forzamos la actualización eliminando el viejo antes de agregar
          rm -f epg_raw.xml
          git add playlist.m3u epg.xml
          # El '|| true' evita que el workflow falle si no hay cambios
          git commit -m "Update Pluto EPG: $(date)" || true
          git push origin main --force
