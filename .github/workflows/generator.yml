name: Pluto TV Latam - Smart Sync
on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Descargar Archivos
        run: |
          curl -L -s "https://raw.githubusercontent.com/iptv-org/iptv/master/streams/mx_pluto.m3u" -o playlist.m3u
          curl -L -s "https://i.mjh.nz/PlutoTV/mx.xml" -o epg_raw.xml

      - name: Mapeo de IDs por Nombre (Python)
        run: |
          python3 - <<EOF
          import xml.etree.ElementTree as ET
          import re

          # 1. Leer nombres y IDs de la lista M3U
          m3u_channels = {}
          with open('playlist.m3u', 'r', encoding='utf-8') as f:
              content = f.read()
              # Buscamos el ID (tvg-id) y el nombre final de la línea que empieza por #EXTINF
              matches = re.findall(r'tvg-id="([^"]+)".*?,([^\n\r]+)', content)
              for tid, name in matches:
                  m3u_channels[name.strip().lower()] = tid

          # 2. Procesar el XML para que coincida con la lista
          tree = ET.parse('epg_raw.xml')
          root = tree.getroot()

          for channel in root.findall('channel'):
              name_element = channel.find('display-name')
              if name_element is not None:
                  chan_name = name_element.text.strip().lower()
                  # Si el nombre del canal está en nuestra lista M3U, le ponemos el ID del M3U
                  if chan_name in m3u_channels:
                      original_id = channel.get('id')
                      new_id = m3u_channels[chan_name]
                      
                      # Actualizamos el ID del canal
                      channel.set('id', new_id)
                      
                      # Actualizamos todas las programaciones que usaban el ID viejo
                      for prog in root.findall(f".//programme[@channel='{original_id}']"):
                          prog.set('channel', new_id)

          tree.write('epg.xml', encoding='utf-8', xml_declaration=True)
          EOF

      - name: Publicar en GitHub
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Bot"
          git add playlist.m3u epg.xml
          git commit -m "Smart Sync Pluto: $(date)" || exit 0
          git push origin main
